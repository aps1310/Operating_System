cscope 15 /gpfs/main/home/qfang/course/cs167/uthreads -q 0000000343 0000026800
	@csyntax.c

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

14 
	$maš
(
¬gc
, ** 
¬gv
) {

16 *
x
;

17 *
x
 = 2;

20  (
EXIT_SUCCESS
);

21 
	}
}

	@interpose.c

15 
	~<¡dio.h
>

16 
	~<fú.h
>

17 
	~<”ºo.h
>

18 
	~<dlfú.h
>

19 
	~<uni¡d.h
>

20 
	~<¡ršg.h
>

21 
	~<¡d¬g.h
>

22 
	~<sigÇl.h
>

23 
	~<dœ’t.h
>

24 
	~<libš.h
>

25 
	~<sys/ty³s.h
>

26 
	~<sys/sock‘.h
>

28 
	~"uth»ad.h
"

30 #ià
defšed
(
__lšux__
è&& defšed(
__i386
)

31 
	#mªgË_Çme
(
lšÇme
, 
sŞÇme
è
c_
##
	)
linname

32 
	#INTERPOSE_NEED_DLOPEN


	)

33 
c_g‘d’ts
(
fd
, 
dœ’t
 *
buf
, cÚ¡ 
size_t
 
couÁ
);

34 
c_acûss
(cÚ¡ *
fe
, 
mode
);

35 
c_chdœ
(cÚ¡ *
fe
);

36 
c_fchdœ
(
fd
);

37 
c_şo£
(
fd
);

38 
c_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...);

39 
pid_t
 
c_fÜk
();

40 
off_t
 
c_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
);

41 
ssize_t
 
c_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

42 
ssize_t
 
c_»ad
(
fd
, * 
buf
, cÚ¡ 
size_t
 
couÁ
);

43 
c_³¼Ü
(cÚ¡ *
s
);

46 #´agm¨
w—k
 
»ad
=
c_»ad


47 #´agm¨
w—k
 
wr™e
=
c_wr™e


48 #´agm¨
w—k
 
İ’
=
c_İ’


49 #´agm¨
w—k
 
şo£
=
c_şo£


50 #´agm¨
w—k
 
l£ek
=
c_l£ek


51 #´agm¨
w—k
 
chdœ
=
c_chdœ


52 #´agm¨
w—k
 
fchdœ
=
c_fchdœ


53 #´agm¨
w—k
 
acûss
=
c_acûss


54 #´agm¨
w—k
 
g‘d’ts
=
c_g‘d’ts


55 #´agm¨
w—k
 
fÜk
=
c_fÜk


56 #´agm¨
w—k
 
³¼Ü
=
c_³¼Ü


58 #´agm¨
w—k
 
__»ad
=
c_»ad


59 #´agm¨
w—k
 
__wr™e
=
c_wr™e


60 #´agm¨
w—k
 
__İ’
=
c_İ’


61 #´agm¨
w—k
 
__şo£
=
c_şo£


62 #´agm¨
w—k
 
__l£ek
=
c_l£ek


63 #´agm¨
w—k
 
__chdœ
=
c_chdœ


64 #´agm¨
w—k
 
__fchdœ
=
c_fchdœ


65 #´agm¨
w—k
 
__acûss
=
c_acûss


66 #´agm¨
w—k
 
__g‘d’ts
=
c_g‘d’ts


67 #´agm¨
w—k
 
__fÜk
=
c_fÜk


68 #´agm¨
w—k
 
__³¼Ü
=
c_³¼Ü


75 #ià
defšed
(
__SVR4
è&& defšed(
__¥¬c
)

76 
	#mªgË_Çme
(
lšÇme
, 
sŞÇme
è
_
##
	)
solname

77 #´agm¨
w—k
 
»ad
=
_»ad


78 #´agm¨
w—k
 
wr™e
=
_wr™e


79 #´agm¨
w—k
 
İ’
=
__İ’


80 #´agm¨
w—k
 
şo£
=
_şo£


81 #´agm¨
w—k
 
l£ek
=
_l£ek


82 #´agm¨
w—k
 
chdœ
=
_chdœ


83 #´agm¨
w—k
 
fchdœ
=
_fchdœ


84 #´agm¨
w—k
 
acûss
=
_acûss


85 #´agm¨
w—k
 
g‘d’ts
=
_g‘d’ts


86 #´agm¨
w—k
 
fÜk
=
__libc_fÜk


87 #´agm¨
w—k
 
³¼Ü
=
_³¼Ü


90 #ià
defšed
 
_WTHREADS


91 
	#mªgË_thr_id
 
	`wth»ad_£lf
()

	)

93 
	#mªgË_thr_id
 0

	)

97 
	$mªgË_Çme
(
³¼Ü
,…error)

98 (cÚ¡ *
s
)

101 
	`årštf
(
¡d”r
, "%s: %s", 
s
, 
	`¡»¼Ü
(
”ºo
));

102 
	}
}

105 
	$mªgË_Çme
(
acûss
,‡ccess)

106 (cÚ¡ *
fe
, 
mode
)

108 (*
	tacûss_func
)(const *, );

109 
acûss_func
 
»®_acûss
;

110 
»t
;

111 #ifdeà
INTERPOSE_NEED_DLOPEN


112 * 
libhªdË
;

115 
	`uth»ad_y›ld
();

117 #ifdeà
INTERPOSE_NEED_DLOPEN


118 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

119 
»®_acûss
 = (
acûss_func
)
	`dlsym
(
libhªdË
, "access");

121 
»®_acûss
 = (
acûss_func
)
	`dlsym
(
RTLD_NEXT
, "access");

124 
»t
 = 
	`»®_acûss
(
fe
, 
mode
);

126 #ifdeà
INTERPOSE_NEED_DLOPEN


127 
	`dlşo£
(
libhªdË
);

130  
»t
;

131 
	}
}

134 
	$mªgË_Çme
(
chdœ
, chdir)

135 (cÚ¡ *
fe
)

137 (*
	tchdœ_func
)(cÚ¡ *
	tfe
);

138 
chdœ_func
 
»®_chdœ
;

139 
»t
;

140 #ifdeà
INTERPOSE_NEED_DLOPEN


141 * 
libhªdË
;

144 
	`uth»ad_y›ld
();

146 #ifdeà
INTERPOSE_NEED_DLOPEN


147 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

148 
»®_chdœ
 = (
chdœ_func
)
	`dlsym
(
libhªdË
, "chdir");

150 
»®_chdœ
 = (
chdœ_func
)
	`dlsym
(
RTLD_NEXT
, "chdir");

153 
»t
 = 
	`»®_chdœ
(
fe
);

155 #ifdeà
INTERPOSE_NEED_DLOPEN


156 
	`dlşo£
(
libhªdË
);

159  
»t
;

160 
	}
}

163 
	$mªgË_Çme
(
fchdœ
, fchdir)

164 (
fd
)

166 (*
	tfchdœ_func
)(
	tfd
);

167 
fchdœ_func
 
»®_fchdœ
;

168 
»t
;

169 #ifdeà
INTERPOSE_NEED_DLOPEN


170 * 
libhªdË
;

173 
	`uth»ad_y›ld
();

175 #ifdeà
INTERPOSE_NEED_DLOPEN


176 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

177 
»®_fchdœ
 = (
fchdœ_func
)
	`dlsym
(
libhªdË
, "chdir");

179 
»®_fchdœ
 = (
fchdœ_func
)
	`dlsym
(
RTLD_NEXT
, "chdir");

182 
»t
 = 
	`»®_fchdœ
(
fd
);

184 #ifdeà
INTERPOSE_NEED_DLOPEN


185 
	`dlşo£
(
libhªdË
);

188  
»t
;

189 
	}
}

191 
pid_t


192 
	$mªgË_Çme
(
fÜk
, 
_libc_fÜk
)

195 
	`pid_t
 (*
	tfÜk_func
)();

196 
fÜk_func
 
»®_fÜk
;

197 
chd
;

199 #ifdeà
INTERPOSE_NEED_DLOPEN


200 * 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

201 
»®_fÜk
 = (
fÜk_func
)
	`dlsym
(
libhªdË
, "fork");

203 
»®_fÜk
 = (
fÜk_func
)
	`dlsym
(
RTLD_NEXT
, "fork");

206 ià((
chd
 = 
	`»®_fÜk
()) == 0)

215 #ifdeà
INTERPOSE_NEED_DLOPEN


216 
	`dlşo£
(
libhªdË
);

219  
chd
;

220 
	}
}

222 
ssize_t


223 
	$mªgË_Çme
(
wr™e
, write)

224 (
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

226 (*
	twr™e_func
)(
	tfd
, cÚ¡ *
	tbuf
, 
	tsize_t
 
	tcouÁ
);

227 
wr™e_func
 
»®_wr™e
;

228 
»t
;

229 #ifdeà
INTERPOSE_NEED_DLOPEN


230 * 
libhªdË
;

233 
	`uth»ad_y›ld
();

235 #ifdeà
INTERPOSE_NEED_DLOPEN


236 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

237 
»®_wr™e
 = (
wr™e_func
)
	`dlsym
(
libhªdË
, "write");

239 
»®_wr™e
 = (
wr™e_func
)
	`dlsym
(
RTLD_NEXT
, "write");

242 
»t
 = 
	`»®_wr™e
(
fd
,
buf
,
couÁ
);

244 #ifdeà
INTERPOSE_NEED_DLOPEN


245 
	`dlşo£
(
libhªdË
);

248  
»t
;

249 
	}
}

251 
off_t


252 
	$mªgË_Çme
(
l£ek
,†seek)

253 (
fd
, 
off_t
 
off£t
, 
wh’û
)

255 (*
	tl£ek_func
)(
	tfd
, 
	toff_t
 
	toff£t
, 
	twh’û
);

256 
l£ek_func
 
»®_l£ek
;

257 
»t
;

258 #ifdeà
INTERPOSE_NEED_DLOPEN


259 * 
libhªdË
;

262 
	`uth»ad_y›ld
();

264 #ifdeà
INTERPOSE_NEED_DLOPEN


265 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

266 
»®_l£ek
 = (
l£ek_func
)
	`dlsym
(
libhªdË
, "lseek");

268 
»®_l£ek
 = (
l£ek_func
)
	`dlsym
(
RTLD_NEXT
, "lseek");

271 
»t
 = 
	`»®_l£ek
(
fd
, 
off£t
, 
wh’û
);

273 #ifdeà
INTERPOSE_NEED_DLOPEN


274 
	`dlşo£
(
libhªdË
);

277  
»t
;

278 
	}
}

281 
	$mªgË_Çme
(
g‘d’ts
, getdents)

282 (
fd
, 
dœ’t
 *
buf
, 
size_t
 
couÁ
)

284 (*
	tg‘d’ts_func
)(
	tfd
, 
	tdœ’t
 *
	tbuf
, 
	tsize_t
 
	tcouÁ
);

285 
g‘d’ts_func
 
»®_g‘d’ts
;

286 
»t
;

287 #ifdeà
INTERPOSE_NEED_DLOPEN


288 * 
libhªdË
;

291 
	`uth»ad_y›ld
();

293 #ifdeà
INTERPOSE_NEED_DLOPEN


294 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

295 
»®_g‘d’ts
 = (
g‘d’ts_func
)
	`dlsym
(
libhªdË
, "getdents");

297 
»®_g‘d’ts
 = (
g‘d’ts_func
)
	`dlsym
(
RTLD_NEXT
, "getdents");

300 
»t
 = 
	`»®_g‘d’ts
(
fd
, 
buf
, 
couÁ
);

302 #ifdeà
INTERPOSE_NEED_DLOPEN


303 
	`dlşo£
(
libhªdË
);

306  
»t
;

307 
	}
}

310 
	$mªgË_Çme
(
şo£
, close)

311 (
fd
)

313 (*
	tşo£_func
)(
	tfd
);

314 
şo£_func
 
»®_şo£
;

315 
»t
;

316 #ifdeà
INTERPOSE_NEED_DLOPEN


317 * 
libhªdË
;

320 
	`uth»ad_y›ld
();

322 #ifdeà
INTERPOSE_NEED_DLOPEN


323 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

324 
»®_şo£
 = (
şo£_func
)
	`dlsym
(
libhªdË
, "close");

326 
»®_şo£
 = (
şo£_func
)
	`dlsym
(
RTLD_NEXT
, "close");

329 
»t
 = 
	`»®_şo£
(
fd
);

331 #ià
	`defšed
(
__lšux__
è&& defšed(
__i386
)

332 
	`dlşo£
(
libhªdË
);

335  
»t
;

336 
	}
}

339 
	$mªgË_Çme
(
İ’
, 
_İ’
)

340 (cÚ¡ *
·thÇme
, 
æags
, ...)

342 (*
	tİ’_func
)(cÚ¡ *
	t·thÇme
, 
	tæags
, ...);

343 
İ’_func
 
»®_İ’
;

344 
»t
;

345 #ifdeà
INTERPOSE_NEED_DLOPEN


346 * 
libhªdË
;

349 
	`uth»ad_y›ld
();

351 #ifdeà
INTERPOSE_NEED_DLOPEN


352 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

353 
»®_İ’
 = (
İ’_func
)
	`dlsym
(
libhªdË
, "open");

355 
»®_İ’
 = (
İ’_func
)
	`dlsym
(
RTLD_NEXT
, "open");

363 
»t
 = 
	`»®_İ’
(
·thÇme
, 
æags
, 0666);

365 #ifdeà
INTERPOSE_NEED_DLOPEN


366 
	`dlşo£
(
libhªdË
);

369  
»t
;

370 
	}
}

372 
ssize_t


373 
	$mªgË_Çme
(
»ad
,„ead)

374 (cÚ¡ 
fd
, * 
buf
, cÚ¡ 
size_t
 
couÁ
)

376 (*
	t»ad_func
)(cÚ¡ 
	tfd
, *
	tbuf
, cÚ¡ 
	tsize_t
 
	tcouÁ
);

377 
»ad_func
 
»®_»ad
;

378 
»t
;

379 #ifdeà
INTERPOSE_NEED_DLOPEN


380 * 
libhªdË
;

383 
	`uth»ad_y›ld
();

385 #ifdeà
INTERPOSE_NEED_DLOPEN


386 
libhªdË
 = 
	`dlİ’
("/lib/libc.so.6", 
RTLD_LAZY
);

387 
»®_»ad
 = (
»ad_func
)
	`dlsym
(
libhªdË
, "read");

389 
»®_»ad
 = (
»ad_func
)
	`dlsym
(
RTLD_NEXT
, "read");

392 
»t
 = 
	`»®_»ad
(
fd
, 
buf
, 
couÁ
);

394 #ifdeà
INTERPOSE_NEED_DLOPEN


395 
	`dlşo£
(
libhªdË
);

398  
»t
;

399 
	}
}

	@list.h

1 #iâdeà
__LIST_H__


2 
	#__LIST_H__


	)

4 
	~<¡ddef.h
>

54 
	sli¡
 {

55 
li¡
 *
	ml_Ãxt
;

56 
li¡
 *
	ml_´ev
;

57 } 
	tli¡_t
, 
	tli¡_lšk_t
;

59 
	#LIST_INITIALIZER
Ğ
li¡
 ) \

60 { (
li¡
), (li¡è}

	)

62 
	#li¡_š™
(
li¡
) \

64 (
li¡
)->
l_Ãxt
 = (li¡)->
l_´ev
 = (list); \

65 } 0)

	)

67 
	#li¡_lšk_š™
(
li¡
) \

69 (
li¡
)->
l_Ãxt
 = (li¡)->
l_´ev
 = 
NULL
; \

70 } 0)

	)

72 
	#li¡_em±y
(
li¡
) \

73 ((
li¡
)->
l_Ãxt
 =ğÖi¡))

	)

75 
	#li¡_š£¹_befÜe
(
Şd
, 
Ãw
) \

77 
li¡_lšk_t
 *
´ev
 = (
Ãw
); \

78 
li¡_lšk_t
 *
Ãxt
 = (
Şd
); \

79 
´ev
->
l_Ãxt
 = 
Ãxt
; \

80 
´ev
->
l_´ev
 = 
Ãxt
->l_prev; \

81 
Ãxt
->
l_´ev
->
l_Ãxt
 = 
´ev
; \

82 
Ãxt
->
l_´ev
 = 
´ev
; \

83 } 0)

	)

85 
	#li¡_š£¹_h—d
(
li¡
, 
lšk
) \

86 
	`li¡_š£¹_befÜe
((
li¡
)->
l_Ãxt
, 
lšk
)

	)

88 
	#li¡_š£¹_
(
li¡
, 
lšk
) \

89 
	`li¡_š£¹_befÜe
(
li¡
, 
lšk
)

	)

91 
	#li¡_»move
(
lšk
) \

93 
li¡_lšk_t
 *
Î
 = (
lšk
); \

94 
li¡_lšk_t
 *
´ev
 = 
Î
->
l_´ev
; \

95 
li¡_lšk_t
 *
Ãxt
 = 
Î
->
l_Ãxt
; \

96 
´ev
->
l_Ãxt
 = 
Ãxt
; \

97 
Ãxt
->
l_´ev
 = 
´ev
; \

98 
Î
->
l_Ãxt
 =†l->
l_´ev
 = 0; \

99 } 0)

	)

101 
	#li¡_»move_h—d
(
li¡
) \

102 
	`li¡_»move
((
li¡
)->
l_Ãxt
)

	)

104 
	#li¡_»move_
(
li¡
) \

105 
	`li¡_»move
((
li¡
)->
l_´ev
)

	)

107 
	#li¡_™em
(
lšk
, 
ty³
, 
memb”
) \

108 (
ty³
*)((*)(
lšk
è- 
	`off£tof
Ñy³, 
memb”
))

	)

110 
	#li¡_h—d
(
li¡
, 
ty³
, 
memb”
) \

111 
	`li¡_™em
((
li¡
)->
l_Ãxt
, 
ty³
, 
memb”
)

	)

113 
	#li¡_
(
li¡
, 
ty³
, 
memb”
) \

114 
	`li¡_™em
((
li¡
)->
l_´ev
, 
ty³
, 
memb”
)

	)

116 
	#li¡_™”©e_begš
(
li¡
, 
v¬
, 
ty³
, 
memb”
) \

118 
li¡_lšk_t
 *
__lšk
; \

119 
li¡_lšk_t
 *
__Ãxt
; \

120 
__lšk
 = (
li¡
)->
l_Ãxt
; \

121 
__lšk
 !ğ(
li¡
); \

122 
__lšk
 = 
__Ãxt
) { \

123 
v¬
 = 
	`li¡_™em
(
__lšk
, 
ty³
, 
memb”
); \

124 
__Ãxt
 = 
__lšk
->
l_Ãxt
; \

125 do

	)

127 
	#li¡_™”©e_’d
() \

130 } 0)

	)

	@test.c

9 
	~<as£¹.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~<uni¡d.h
>

13 
	~<¡ršg.h
>

14 
	~"uth»ad.h
"

15 
	~"uth»ad_mtx.h
"

16 
	~"uth»ad_cÚd.h
"

18 
	#NUM_THREADS
 3

	)

20 
	#SBUFSZ
 256

	)

22 
uth»ad_id_t
 
	gthr
[
NUM_THREADS
];

23 
uth»ad_mtx_t
 
	gmtx
;

24 
uth»ad_cÚd_t
 
	gcÚd
;

30 
	$‹¡”
(
a0
, *
a1
)

32 
i
 = 0, 
»t
;

33 
pbufãr
[
SBUFSZ
];

35 
i
 < 10)

37 
	`¥rštf
(
pbufãr
, "th»ad %i: h–lo! (%i)\n", 
	`uth»ad_£lf
(), 
i
++);

38 
»t
 = 
	`wr™e
(
STDOUT_FILENO
, 
pbufãr
, 
	`¡¾’
(pbuffer));

39 ià(
»t
 < 0)

41 
	`³¼Ü
("uthreads_test");

43 
	`ex™
(1);

46 
	`uth»ad_mtx_lock
(&
mtx
);

47 
	`uth»ad_cÚd_sigÇl
(&
cÚd
);

48 
	`uth»ad_cÚd_wa™
(&
cÚd
, &
mtx
);

49 
	`uth»ad_mtx_uÆock
(&
mtx
);

52 
	`¥rštf
(
pbufãr
, "th»ad %˜ex™šg.\n", 
	`uth»ad_£lf
());

53 
»t
 = 
	`wr™e
(
STDOUT_FILENO
, 
pbufãr
, 
	`¡¾’
(pbuffer));

54 ià(
»t
 < 0)

56 
	`³¼Ü
("uthreads_test");

58 
	`ex™
(1);

61 
	`uth»ad_ex™
(
a0
);

62 
	}
}

65 
	$maš
(
ac
, **
av
)

67 
i
;

76 
	`´štf
("hello\n");

78 
	`uth»ad_š™
();

79 
	`uth»ad_mtx_š™
(&
mtx
);

80 
	`uth»ad_cÚd_š™
(&
cÚd
);

82 
i
 = 0; i < 
NUM_THREADS
; i++)

84 
	`uth»ad_ü—‹
(&
thr
[
i
], 
‹¡”
, i, 
NULL
, 0);

86 
	`uth»ad_£rio
(
thr
[0], 2);

89 
i
 = 0; i < 
NUM_THREADS
; i++)

91 
pbufãr
[
SBUFSZ
];

92 
tmp
, 
»t
;

94 
	`uth»ad_još
(
thr
[
i
], &
tmp
);

96 
	`¥rštf
(
pbufãr
, "jošed w™hh»ad %i,ƒx™ed %i.\n", 
thr
[
i
], 
tmp
);

97 
»t
 = 
	`wr™e
(
STDOUT_FILENO
, 
pbufãr
, 
	`¡¾’
(pbuffer));

98 ià(
»t
 < 0)

100 
	`³¼Ü
("uthreads_test");

101  
EXIT_FAILURE
;

104 
	`uth»ad_mtx_lock
(&
mtx
);

105 
	`uth»ad_cÚd_sigÇl
(&
cÚd
);

106 
	`uth»ad_mtx_uÆock
(&
mtx
);

109 
	`uth»ad_ex™
(0);

112 
	}
}

	@uthread.c

8 
	~<as£¹.h
>

9 
	~<¡dio.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<sys/”ºo.h
>

13 
	~<sys/ty³s.h
>

14 
	~<uni¡d.h
>

15 
	~"uth»ad.h
"

16 
	~"uth»ad_´iv©e.h
"

17 
	~"uth»ad_queue.h
"

18 
	~"uth»ad_boŞ.h
"

22 
uth»ad_t
 *
	gut_cu¹hr
 = 
NULL
;

23 
uth»ad_t
 
	guth»ads
[
UTH_MAX_UTHREADS
];

24 
li¡_t
 
	g»­_queue
;

25 
uth»ad_id_t
 
	g»­”_thr_id
;

28 
ü—‹_fœ¡_thr
();

29 
uth»ad_id_t
 
uth»ad_®loc
();

30 
uth»ad_de¡roy
(
uth»ad_t
 *
th»ad
);

31 *
®loc_¡ack
();

32 
ä“_¡ack
(*
¡ack
);

33 
»­”_š™
();

34 
»­”
(
a0
, *
a1
);

35 
make_»­abË
(
uth»ad_t
 *
uth
);

48 
	$uth»ad_š™
()

51 
i
;

52  
i
=0; i < 
UTH_MAX_UTHREADS
; i++) {

53 
	`mem£t
(&
uth»ads
[
i
],0,(
uth»ad_t
));

54 
uth»ads
[
i
].
ut_¡©e
 = 
UT_NO_STATE
;

55 
uth»ads
[
i
].
ut_id
 = i;

61 
	`uth»ad_sched_š™
();

62 
	`»­”_š™
();

63 
	`ü—‹_fœ¡_thr
();

64 
	}
}

80 
	$uth»ad_ü—‹
(
uth»ad_id_t
 *
uidp
, 
uth»ad_func_t
 
func
, 
¬g1
, *
¬g2
, 
´io
)

84 
»t
 = 
	`uth»ad_®loc
();

85 iàĞ
»t
 == -1) {

88 *
uidp
 = 
»t
;

89 
uth»ads
[
»t
].
ut_id
 =„et;

90 
uth»ads
[
»t
].
ut_¡©e
 = 
UT_RUNNABLE
;

91 
uth»ads
[
»t
].
ut_´io
 = 
´io
;

92 
uth»ads
[
»t
].
ut_¡ack
 = 
	`®loc_¡ack
();

93 
	`uth»ad_makecÚ‹xt
(&
uth»ads
[
»t
].
ut_ùx
,uth»ads[»t].
ut_¡ack
,
UTH_STACK_SIZE
, 
func
, 
¬g1
, 
¬g2
);

94 
	`Ãw_th»ad_’queue
(&
uth»ads
[
»t
]);

96 
	}
}

109 
	$uth»ad_ex™
(
¡©us
)

112 
ut_cu¹hr
->
ut_has_ex™ed
 = 1;

113 
ut_cu¹hr
->
ut_¡©e
 = 
UT_ZOMBIE
;

114 ià(
ut_cu¹hr
->
ut_d‘ached
 != 1) {

115 
ut_cu¹hr
->
ut_ex™
 = 
¡©us
;

116 ià(
ut_cu¹hr
->
ut_wa™”
) {

117 
	`uth»ad_wake
(
ut_cu¹hr
->
ut_wa™”
);

120 ià(
ut_cu¹hr
->
ut_d‘ached
 == 1) {

121 
	`make_»­abË
(
ut_cu¹hr
);

123 
	`uth»ad_sw™ch
();

124 
	`PANIC
("returnedo‡ deadhread");

125 
	}
}

149 
	$uth»ad_još
(
uth»ad_id_t
 
uid
, *
»tuº_v®ue
)

153 iàĞ
uid
 < 0 || uid > 
UTH_MAX_UTHREADS
) {

154 
uth»ads
[
uid
].
ut_”ºo
 = 
ESRCH
;

158 iàĞ
uth»ads
[
uid
].
ut_d‘ached
 ) {

159 
uth»ads
[
uid
].
ut_”ºo
 = 
EINVAL
;

163 ià(
uth»ads
[
uid
].
ut_wa™”
) {

164 
uth»ads
[
uid
].
ut_”ºo
 = 
EINVAL
;

168 
uth»ads
[
uid
].
ut_wa™”
 = 
ut_cu¹hr
;

169  
uth»ads
[
uid
].
ut_has_ex™ed
 != 1) {

170 
	`uth»ad_block
();

172 ià(
»tuº_v®ue
) {

173 *
»tuº_v®ue
 = 
uth»ads
[
uid
].
ut_ex™
;

175 
uth»ads
[
uid
].
ut_d‘ached
 = 1;

176 
	`make_»­abË
(&
uth»ads
[
uid
]);

178 
	}
}

199 
	$uth»ad_d‘ach
(
uth»ad_id_t
 
uid
)

202 iàĞ
uid
 < 0 || uid > 
UTH_MAX_UTHREADS
) {

203 
uth»ads
[
uid
].
ut_”ºo
 = 
ESRCH
;

207 ià(
uth»ads
[
uid
].
ut_¡©e
 =ğ
UT_ZOMBIE
) {

208 
uth»ads
[
uid
].
ut_d‘ached
 = 1;

209 
	`make_»­abË
(&
uth»ads
[
uid
]);

212 
uth»ads
[
uid
].
ut_d‘ached
 = 1;

214 
	}
}

223 
uth»ad_id_t


224 
	$uth»ad_£lf
()

226 
	`as£¹
(
ut_cu¹hr
 !ğ
NULL
);

227  
ut_cu¹hr
->
ut_id
;

228 
	}
}

243 
uth»ad_id_t


244 
__©Œibu‹__
((
unu£d
)è
	$uth»ad_®loc
()

247 
i
;

248  
i
 = 0; i < 
UTH_MAX_UTHREADS
; i++) {

249 iàĞ
uth»ads
[
i
].
ut_¡©e
 =ğ
UT_NO_STATE
 ) {

250  
uth»ads
[
i
].
ut_id
;

254 
	}
}

263 
	$uth»ad_de¡roy
(
uth»ad_t
 *
uth
)

266 
	`ä“
(
uth
->
ut_¡ack
);

267 
	`mem£t
(
uth
,0,(
uth»ad_t
));

268 
uth
->
ut_¡©e
 = 
UT_NO_STATE
;

269 
	}
}

281 
	$»­”_š™
()

283 
	`li¡_š™
(&
»­_queue
);

284 
	`uth»ad_ü—‹
(&
»­”_thr_id
, 
»­”
, 0, 
NULL
, 
UTH_MAXPRIO
);

285 
	`as£¹
(
»­”_thr_id
 != -1);

286 
	}
}

300 
	$»­”
(
a0
, *
a1
)

304 
uth»ad_t
 *
th»ad
;

305 
th
;

308 
	`uth»ad_block
();

313 
	`li¡_™”©e_begš
(&
»­_queue
, 
th»ad
, 
uth»ad_t
, 
ut_lšk
)

315 
	`as£¹
(
th»ad
->
ut_¡©e
 =ğ
UT_ZOMBIE
);

317 
	`li¡_»move
(&
th»ad
->
ut_lšk
);

318 
	`uth»ad_de¡roy
(
th»ad
);

320 
	`li¡_™”©e_’d
();

323 
th
 = 0;h < 
UTH_MAX_UTHREADS
;h++)

325 ià(
th
 !ğ
»­”_thr_id
 &&

326 
uth»ads
[
th
].
ut_¡©e
 !ğ
UT_NO_STATE
)

332 ià(
th
 =ğ
UTH_MAX_UTHREADS
)

335 
	`årštf
(
¡d”r
, "uthreads:‚o morehreads.\n");

336 
	`årštf
(
¡d”r
, "uthreads: bye!\n");

337 
	`ex™
(0);

340 
	}
}

351 
	$ü—‹_fœ¡_thr
()

353 
uth»ad_t
 
hack
;

354 
uth»ad_id_t
 
maš_thr
;

371 
	`mem£t
(&
hack
, 0, (
uth»ad_t
));

372 
ut_cu¹hr
 = &
hack
;

373 
ut_cu¹hr
->
ut_¡©e
 = 
UT_ON_CPU
;

375 
	`uth»ad_ü—‹
(&
maš_thr
,

376 (
uth»ad_func_t
)0, 0, 
NULL
,

377 
UTH_MAXPRIO
);

378 
	`as£¹
(
maš_thr
 != -1);

379 
	`uth»ad_d‘ach
(
maš_thr
);

386 
	`uth»ad_g‘cÚ‹xt
(&
uth»ads
[
maš_thr
].
ut_ùx
);

388 ià(
ut_cu¹hr
 =ğ&
hack
)

390 
	`uth»ad_sw™ch
();

395 
	`as£¹
(
	`uth»ad_£lf
(è=ğ
maš_thr
);

398 
	}
}

408 
__©Œibu‹__
((
unu£d
)è
	$make_»­abË
(
uth»ad_t
 *
uth
)

410 
	`as£¹
(
uth
->
ut_d‘ached
);

411 
	`as£¹
(
uth
->
ut_¡©e
 =ğ
UT_ZOMBIE
);

412 
	`li¡_š£¹_
(&
»­_queue
, &
uth
->
ut_lšk
);

413 
	`uth»ad_wake
(&
uth»ads
[
»­”_thr_id
]);

414 
	}
}

417 
__©Œibu‹__
((
unu£d
)è*
	$®loc_¡ack
()

419  (*)
	`m®loc
(
UTH_STACK_SIZE
);

420 
	}
}

423 
__©Œibu‹__
((
unu£d
)è
	$ä“_¡ack
(*
¡ack
)

425 
	`ä“
(
¡ack
);

426 
	}
}

	@uthread.h

9 #iâdeà
__uth»ad_h__


10 
	#__uth»ad_h__


	)

12 
	~<sys/ty³s.h
>

13 
	~"uth»ad_ùx.h
"

14 
	~"li¡.h
"

18 
	#UTH_MAXPRIO
 7

	)

19 
	#UTH_MAX_UTHREADS
 64

	)

20 
	#UTH_STACK_SIZE
 64*1024

	)

22 
	#NOT_YET_IMPLEMENTED
(
msg
) \

24 
	`årštf
(
¡d”r
, "Not yet implemented‡t %s:%i -- %s\n", \

25 
__FILE__
, 
__LINE__
, (
msg
)); \

26 } 0);

	)

28 
	#PANIC
(
”r
) \

30 
	`årštf
(
¡d”r
, "PANIC‡t %s:%i -- %s\n", \

31 
__FILE__
, 
__LINE__
, 
”r
); \

32 
	`abÜt
(); \

33 } 0);

	)

35 #undeà
”ºo


36 
	#”ºo
 (
ut_cu¹hr
->
ut_”ºo
)

	)

39 
	tuth»ad_id_t
;

40 (*
	tuth»ad_func_t
)(, *);

44 
UT_NO_STATE
,

45 
UT_ON_CPU
,

46 
UT_RUNNABLE
,

47 
UT_WAIT
,

48 
UT_ZOMBIE
,

50 
UT_NUM_THREAD_STATES


51 } 
	tuth»ad_¡©e_t
;

55 
	suth»ad
 {

56 
li¡_lšk_t
 
ut_lšk
;

58 
uth»ad_ùx_t
 
ut_ùx
;

59 *
ut_¡ack
;

61 
uth»ad_id_t
 
ut_id
;

62 
uth»ad_¡©e_t
 
ut_¡©e
;

63 
ut_´io
;

64 
ut_”ºo
;

65 
ut_has_ex™ed
;

66 
ut_ex™
;

68 
ut_d‘ached
;

69 
uth»ad
 *
ut_wa™”
;

70 } 
	tuth»ad_t
;

75 
uth»ad_t
 
uth»ads
[
UTH_MAX_UTHREADS
];

76 
uth»ad_t
 *
ut_cu¹hr
;

78 
	`uth»ad_š™
();

80 
	`uth»ad_ü—‹
(
uth»ad_id_t
 *
id
, 
uth»ad_func_t
 
func
, 
¬g1
,

81 *
¬g2
, 
´io
);

82 
	`uth»ad_ex™
(
¡©us
);

83 
uth»ad_id_t
 
	`uth»ad_£lf
();

85 
	`uth»ad_još
(
uth»ad_id_t
 
id
, *
ex™_v®ue
);

86 
	`uth»ad_d‘ach
(
uth»ad_id_t
 
id
);

89 
	`uth»ad_£rio
(
uth»ad_id_t
 
id
, 
´io
);

90 
	`uth»ad_y›ld
();

91 
	`uth»ad_block
();

92 
	`uth»ad_wake
(
uth»ad_t
 *
uthr
);

	@uthread_bool.h

1 #iâdeà
_uth»ad_boŞ_h_


2 
	#_uth»ad_boŞ_h_


	)

7 
	tboŞ
;

9 #iâdeà
Œue


10 
	#Œue
 1

	)

13 #iâdeà
çl£


14 
	#çl£
 0

	)

	@uthread_cond.c

9 
	~<as£¹.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

13 
	~"uth»ad.h
"

14 
	~"uth»ad_mtx.h
"

15 
	~"uth»ad_cÚd.h
"

16 
	~"uth»ad_queue.h
"

25 
	$uth»ad_cÚd_š™
(
uth»ad_cÚd_t
 *
cÚd
)

27 
	`utqueue_š™
(&
cÚd
->
uc_wa™”s
);

29 
	}
}

40 
	$uth»ad_cÚd_wa™
(
uth»ad_cÚd_t
 *
cÚd
, 
uth»ad_mtx_t
 *
mtx
)

42 
	`as£¹
Ğ
mtx
->
m_owÃr
 =ğ
ut_cu¹hr
);

43 
ut_cu¹hr
->
ut_¡©e
 = 
UT_WAIT
;

44 
	`utqueue_’queue
(&
cÚd
->
uc_wa™”s
, 
ut_cu¹hr
);

45 
	`uth»ad_mtx_uÆock
(
mtx
);

46 
	`uth»ad_block
();

47 
	`uth»ad_mtx_lock
(
mtx
);

49 
	}
}

58 
	$uth»ad_cÚd_brßdÿ¡
(
uth»ad_cÚd_t
 *
cÚd
)

60 
uth»ad_t
 *
‹mp
;

61 !
	`utqueue_em±y
(&
cÚd
->
uc_wa™”s
)) {

62 
‹mp
 = 
	`utqueue_dequeue
(&
cÚd
->
uc_wa™”s
);

63 
	`uth»ad_wake
(
‹mp
);

67 
	}
}

76 
	$uth»ad_cÚd_sigÇl
(
uth»ad_cÚd_t
 *
cÚd
)

78 
uth»ad_t
 *
‹mp
;

79 ià(!
	`utqueue_em±y
(&
cÚd
->
uc_wa™”s
)) {

80 
‹mp
 = 
	`utqueue_dequeue
(&
cÚd
->
uc_wa™”s
);

81 
	`uth»ad_wake
(
‹mp
);

84 
	}
}

	@uthread_cond.h

9 #iâdeà
__uth»ad_cÚd_h__


10 
	#__uth»ad_cÚd_h__


	)

13 
	guth»ad_mtx
;

14 
	gutqueue
;

16 
	suth»ad_cÚd
 {

17 
utqueue
 
	muc_wa™”s
;

18 } 
	tuth»ad_cÚd_t
;

21 
uth»ad_cÚd_š™
(
uth»ad_cÚd_t
 *);

22 
uth»ad_cÚd_wa™
(
uth»ad_cÚd_t
 *, 
uth»ad_mtx
 *);

23 
uth»ad_cÚd_sigÇl
(
uth»ad_cÚd_t
 *);

24 
uth»ad_cÚd_brßdÿ¡
(
uth»ad_cÚd_t
 *);

	@uthread_ctx.c

9 
	~<as£¹.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

13 
	~"uth»ad.h
"

14 
	~"uth»ad_ùx.h
"

17 
th»ad_¡¬t
((*
func
)(), 
¬g1
, *
¬g2
);

23 
uth»ad_makecÚ‹xt
(
uth»ad_ùx_t
 *
ùx
, *
¡ack
, 
¡acksz
,

24 (*
func
)(), 
¬g1
, *
¬g2
)

26 
	grv
;

28 
as£¹
(
ùx
 !ğ
NULL
);

29 
as£¹
(
¡ack
 !ğ
NULL
 && 
¡acksz
 > 0);

32 
	grv
 = 
g‘cÚ‹xt
(
ùx
);

33 
as£¹
(
rv
 != -1);

36 #ià
defšed
(
__lšux__
è&& defšed(
__i386
)

37 
	gùx
->
	guc_¡ack
.
	gss_¥
 = (*)
¡ack
;

39 
	gùx
->
	guc_¡ack
.
	gss_¥
 = (*)(
¡ack
 + 
¡acksz
 - 2*());

41 
	gùx
->
	guc_¡ack
.
	gss_size
 = 
¡acksz
;

42 
	gùx
->
	guc_¡ack
.
	gss_æags
 = 0;

43 
	gùx
->
	guc_lšk
 = 
NULL
;

46 
makecÚ‹xt
(
ùx
, ((*)())
th»ad_¡¬t
, 3, 
func
, 
¬g1
, 
¬g2
);

52 
	$uth»ad_£tcÚ‹xt
(
uth»ad_ùx_t
 *
ùx
)

54 
	`as£¹
(
ùx
 !ğ
NULL
);

55 
	`£tcÚ‹xt
(
ùx
);

56 
	}
}

59 
	$uth»ad_sw­cÚ‹xt
(
uth»ad_ùx_t
 *
Şdùx
, uth»ad_ùx_ˆ*
Ãwùx
)

61 
	`as£¹
(
Şdùx
 !ğ
NULL
 && 
Ãwùx
 != NULL);

62 
	`sw­cÚ‹xt
(
Şdùx
, 
Ãwùx
);

63 
	}
}

70 
th»ad_¡¬t
((*
func
)(), 
¬g1
, *
¬g2
)

72 
as£¹
(
func
 !ğ
NULL
);

73 (
	gfunc
)(
	g¬g1
, 
	g¬g2
);

76 
uth»ad_ex™
(0);

	@uthread_ctx.h

9 #iâdeà
__uth»ad_lšux_ùx_h__


10 
	#__uth»ad_lšux_ùx_h__


	)

12 #ifdeà
_REENTRANT


13 #”rÜ 
Compšg
 -
mt
 
is
 
NOT
 
suµÜ‹d


16 
	~<ucÚ‹xt.h
>

18 
ucÚ‹xt_t
 
	tuth»ad_ùx_t
;

26 
uth»ad_makecÚ‹xt
(
uth»ad_ùx_t
 *
ùx
, *
¡ack
, 
¡acksz
,

27 (*
func
)(), 
¬g1
, *
¬g2
);

31 
uth»ad_£tcÚ‹xt
(
uth»ad_ùx_t
 *
ùx
);

36 
	#uth»ad_g‘cÚ‹xt
(
ùx
) \

38 
	`as£¹
(
ùx
); \

39 
	`g‘cÚ‹xt
(
ùx
); \

40 } 0);

	)

47 
uth»ad_sw­cÚ‹xt
(
uth»ad_ùx_t
 *
Şdùx
, uth»ad_ùx_ˆ*
Ãwùx
);

	@uthread_idle.c

9 
	~<sched.h
>

11 
	~"uth»ad.h
"

12 
	~"uth»ad_´iv©e.h
"

23 
	$uth»ad_idË
()

25 #ià
	`defšed
(
__lšux__
è&& defšed(
__i386
)

26 
	`sched_y›ld
();

29 
	`y›ld
();

31 
	}
}

	@uthread_mtx.c

9 
	~<as£¹.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

13 
	~"li¡.h
"

14 
	~"uth»ad.h
"

15 
	~"uth»ad_mtx.h
"

24 
	$uth»ad_mtx_š™
(
uth»ad_mtx_t
 *
mtx
)

26 
mtx
->
m_owÃr
 = 
NULL
;

27 
	`utqueue_š™
(&
mtx
->
m_wa™”s
);

29 
	}
}

38 
	$uth»ad_mtx_lock
(
uth»ad_mtx_t
 *
mtx
)

40 ià(
mtx
->
m_owÃr
) {

41 
ut_cu¹hr
->
ut_¡©e
 = 
UT_WAIT
;

42 
	`utqueue_’queue
(&
mtx
->
m_wa™”s
, 
ut_cu¹hr
);

43 
	`uth»ad_block
();

47 
mtx
->
m_owÃr
 = 
ut_cu¹hr
;

50 
	}
}

60 
	$uth»ad_mtx_Œylock
(
uth»ad_mtx_t
 *
mtx
)

62 ià(!
mtx
->
m_owÃr
) {

63 
mtx
->
m_owÃr
 = 
ut_cu¹hr
;

68 
	}
}

79 
	$uth»ad_mtx_uÆock
(
uth»ad_mtx_t
 *
mtx
)

81 ià(
	`utqueue_em±y
(&
mtx
->
m_wa™”s
)) {

82 
mtx
->
m_owÃr
 = 
NULL
;

85 
uth»ad_t
 *
Ãxt_th»ad
 = 
	`utqueue_dequeue
(&
mtx
->
m_wa™”s
);

86 
mtx
->
m_owÃr
 = 
Ãxt_th»ad
;

87 
	`uth»ad_wake
(
Ãxt_th»ad
);

90 
	}
}

	@uthread_mtx.h

9 #iâdeà
__uth»ad_mtx_h__


10 
	#__uth»ad_mtx_h__


	)

13 
	~"uth»ad_queue.h
"

16 
	guth»ad
;

18 
	suth»ad_mtx
 {

19 
uth»ad
 *
	mm_owÃr
;

20 
utqueue_t
 
	mm_wa™”s
;

21 } 
	tuth»ad_mtx_t
;

23 
uth»ad_mtx_š™
(
uth»ad_mtx_t
 *
mtx
);

24 
uth»ad_mtx_lock
(
uth»ad_mtx_t
 *
mtx
);

25 
uth»ad_mtx_uÆock
(
uth»ad_mtx_t
 *
mtx
);

26 
uth»ad_mtx_Œylock
(
uth»ad_mtx_t
 *
mtx
);

	@uthread_private.h

9 #iâdeà
__uth»ad_´iv©e_h__


10 
	#__uth»ad_´iv©e_h__


	)

16 
uth»ad_sched_š™
();

24 
uth»ad_sw™ch
();

31 
uth»ad_idË
();

	@uthread_queue.c

9 
	~<as£¹.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

13 
	~"uth»ad.h
"

14 
	~"uth»ad_queue.h
"

22 
	$utqueue_š™
(
utqueue_t
 *
q
)

24 
	`as£¹
(
q
 !ğ
NULL
);

26 
	`li¡_š™
(&
q
->
tq_wa™”s
);

27 
q
->
tq_size
 = 0;

28 
	}
}

38 
	$utqueue_em±y
(
utqueue_t
 *
q
)

40 
	`as£¹
(
q
 !ğ
NULL
);

41 
	`as£¹
(
	`li¡_em±y
(&
q
->
tq_wa™”s
è=ğ(q->
tq_size
 == 0));

43  (
q
->
tq_size
 == 0);

44 
	}
}

52 
	$utqueue_’queue
(
utqueue_t
 *
q
, 
uth»ad_t
 *
thr
)

54 
	`as£¹
(
thr
->
ut_lšk
.
l_Ãxt
 =ğ
NULL
 &&hr->ut_lšk.
l_´ev
 == NULL);

56 
	`li¡_š£¹_h—d
(&
q
->
tq_wa™”s
, &
thr
->
ut_lšk
);

57 
q
->
tq_size
++;

58 
	}
}

64 
uth»ad_t
 *

65 
	$utqueue_dequeue
(
utqueue_t
 *
q
)

67 
uth»ad_t
 *
thr
;

68 
li¡_lšk_t
 *
lšk
;

70 
	`as£¹
(
q
 !ğ
NULL
);

72 ià(
	`utqueue_em±y
(
q
))

74  
NULL
;

77 
lšk
 = 
q
->
tq_wa™”s
.
l_´ev
;

78 
thr
 = 
	`li¡_™em
(
lšk
, 
uth»ad_t
, 
ut_lšk
);

79 
	`li¡_»move
(
lšk
);

81 
q
->
tq_size
--;

83  
thr
;

84 
	}
}

93 
	$utqueue_»move
(
utqueue_t
 *
q
, 
uth»ad_t
 *
thr
)

95 
	`as£¹
(
thr
->
ut_lšk
.
l_Ãxt
 !ğ
NULL
 &&hr->ut_lšk.
l_´ev
 != NULL);

97 
	`li¡_»move
(&
thr
->
ut_lšk
);

98 
q
->
tq_size
--;

99 
	}
}

	@uthread_queue.h

9 #iâdeà
__uth»ad_queue_h__


10 
	#__uth»ad_queue_h__


	)

12 
	~"li¡.h
"

15 
	guth»ad
;

17 
	sutqueue
 {

18 
li¡_t
 
	mtq_wa™”s
;

19 
	mtq_size
;

20 } 
	tutqueue_t
;

25 
utqueue_š™
(
utqueue_t
 *
q
);

26 
utqueue_em±y
(
utqueue_t
 *
q
);

27 
utqueue_’queue
(
utqueue_t
 *
q
, 
uth»ad
 *
thr
);

28 
utqueue_»move
(
utqueue_t
 *
q
, 
uth»ad
 *
thr
);

29 
uth»ad
 *
utqueue_dequeue
(
utqueue_t
 *
q
);

30 
Ãw_th»ad_’queue
(
uth»ad_t
 *
uthr
);

	@uthread_sched.c

9 
	~<as£¹.h
>

10 
	~<¡dio.h
>

11 
	~<¡dlib.h
>

12 
	~"uth»ad.h
"

13 
	~"uth»ad_´iv©e.h
"

14 
	~"uth»ad_ùx.h
"

15 
	~"uth»ad_queue.h
"

16 
	~"uth»ad_boŞ.h
"

22 
utqueue_t
 
__©Œibu‹__
((
unu£d
)è
	grunq_bË
[
UTH_MAXPRIO
 + 1];

28 
	$Ãw_th»ad_’queue
(
uth»ad_t
 *
uthr
) {

29 
	`utqueue_’queue
(&
runq_bË
[
uthr
->
ut_´io
],uthr);

30 
	}
}

45 
	$uth»ad_y›ld
()

47 
ut_cu¹hr
->
ut_¡©e
 = 
UT_RUNNABLE
;

48 
	`utqueue_’queue
(&
runq_bË
[
ut_cu¹hr
->
ut_´io
], ut_curthr);

49 
	`uth»ad_sw™ch
();

51 
	}
}

60 
	$uth»ad_block
()

62 
ut_cu¹hr
->
ut_¡©e
 = 
UT_WAIT
;

63 
	`uth»ad_sw™ch
();

65 
	}
}

77 
	$uth»ad_wake
(
uth»ad_t
 *
uthr
)

79 iàĞ
uthr
->
ut_¡©e
 =ğ
UT_WAIT
 ){

80 
uthr
->
ut_¡©e
 = 
UT_RUNNABLE
;

81 
	`utqueue_’queue
(&
runq_bË
[
uthr
->
ut_´io
], uthr);

85 
	}
}

97 
	$uth»ad_£rio
(
uth»ad_id_t
 
id
, 
´io
)

100 iàĞ
uth»ads
[
id
].
ut_¡©e
 =ğ
UT_RUNNABLE
) {

101 
	`utqueue_»move
(&
runq_bË
[
uth»ads
[
id
].
ut_´io
], &uthreads[id]);

102 
uth»ads
[
id
].
ut_´io
 = 
´io
;

103 
	`utqueue_’queue
(&
runq_bË
[
uth»ads
[
id
].
ut_´io
], &uthreads[id]);

106 
uth»ads
[
id
].
ut_´io
 = 
´io
;

107 
	`NOT_YET_IMPLEMENTED
("UTHREADS: uthread_setprio");

108 
	}
}

131 
	$uth»ad_sw™ch
()

134 
uth»ad_t
 *
ruÂabË_highe¡_´iÜ™y_th»ad
;

135 
wa™šg
 = 1;

136 
wa™šg
) {

137 
	`uth»ad_idË
();

138 
i
;

139  
i
 = 
UTH_MAXPRIO
; i >= 0; i--){

140 iàĞ
	`utqueue_em±y
(&
runq_bË
[
i
]) != 1) {

141 
ruÂabË_highe¡_´iÜ™y_th»ad
 = 
	`utqueue_dequeue
(&
runq_bË
[
i
]);

142 
wa™šg
 = 0;

147 
ruÂabË_highe¡_´iÜ™y_th»ad
->
ut_¡©e
 = 
UT_ON_CPU
;

148 
uth»ad_t
 *
Şd
 = 
ut_cu¹hr
;

149 
ut_cu¹hr
 = 
ruÂabË_highe¡_´iÜ™y_th»ad
;

150 
	`uth»ad_sw­cÚ‹xt
(&
Şd
->
ut_ùx
,&
ruÂabË_highe¡_´iÜ™y_th»ad
->ut_ctx);

151 
	}
}

159 
	$uth»ad_sched_š™
()

161 
i
;

162  
i
 = 0; i < 
UTH_MAXPRIO
 + 1; i++) {

163 
	`utqueue_š™
(&
runq_bË
[
i
]);

166 
	}
}

	@
1
.
0
18
238
csyntax.c
interpose.c
list.h
test.c
uthread.c
uthread.h
uthread_bool.h
uthread_cond.c
uthread_cond.h
uthread_ctx.c
uthread_ctx.h
uthread_idle.c
uthread_mtx.c
uthread_mtx.h
uthread_private.h
uthread_queue.c
uthread_queue.h
uthread_sched.c
